# automatizare unPi cu ansible :: doar pentru Raspbian OS/apps
# sub licenta BSD-3, copyright Ciprian Manea <ciprian@unpi.ro>
# unPi Â® este o marca inregistrata in Romania de Ciprian Manea
---
- hosts: localhost
  connection: local

  vars_prompt:

  - name: esteundar
    prompt: "Esti un BENEFICIAR al Asociatiei unPi pentru Scolari?"
    private: no
    default: "DA"

  - name: hashedcode
    prompt: "Care este PAROLA pe care ai primit-o de la Asociatia unPi?"
    encrypt: "scrypt"
    salt: "@unPi"
    private: no
    confirm: yes

  tasks:

   # este beneficiar daca a primit unPi in dar
   - set_fact: beneficiar=true verificat=false
     when: esteundar | upper == "DA" or esteundar | bool

   # nu este beneficiar daca nu a primit unPi in dar
   - set_fact: beneficiar=false verificat=false
     when: esteundar | upper != "DA" and not esteundar | bool

   - name: "Pregatesc un director pentru configuratia unPi"
     file:
       dest: "/root/.unpi"
       mode: u=rwx,g=,o=
       state: directory
     become: yes

   - name: "Salvez raspunsul la intrebarea daca esti BENEFICIAR"
     copy:
       dest: /root/.unpi/esteundar
       mode: u=rw,g=,o=
       content: "{{ esteundar }}"
     become: yes

   - name: "Salvez raspunsul la intrebarea despre PAROLA ta unPi"
     copy:
       dest: /root/.unpi/hashedcode
       mode: u=rw,g=,o=
       content: "{{ hashedcode }}"
     become: yes

   - set_fact: token="{{ hashedcode | password_hash('sha256', 'unPi') | regex_replace('^.*[$]','') | regex_replace('[./]','') }}"

   - name: "Verificam daca esti beneficiar al Asociatiei unPi pentru Scolari"
     uri:
       url: "http://ping.unpi.ro/check/{{ token }}"
       http_agent: "{{ token }}"
       status_code: [200,404]
       timeout: 10
       return_content: yes
     when: beneficiar and ansible_lsb.id == "Raspbian"
     register: check

   - set_fact: verificat=true
     when: check.status == 200 and check.content is defined and 'ok' in check.content

   - name: "Salvez profilul tau de beneficiar unPi"
     set_fact: profile="{{ check.content | from_yaml }}"
     when: verificat

   - copy:
       dest: /root/.unpi/profile.token
       mode: u=rw,g=,o=
       content: "{{ token }}"
     become: yes
     when: verificat

   - copy:
       dest: /root/.unpi/profile.dynpin
       mode: u=rw,g=,o=
       content: "{{ profile.dynpin }}"
     become: yes
     when: verificat and profile.dynpin is defined

   - name: "Activez detectarea dinamica a conexiunii la Internet"
     get_url:
       url: https://infra.unpi.ro/files/dynrun.sh
       dest: /etc/network/if-up.d/dynrun.sh
       mode: u=rwx,g=,o=
       checksum: sha256:https://infra.unpi.ro/files/sha256sum.txt
     become: yes
     when: verificat

   - name: "Salvez programul administrativ pentru calculatorul unPi"
     get_url:
       url: https://infra.unpi.ro/files/boot.sh
       dest: /root/.unpi/boot.sh
       mode: u=rwx,g=,o=
       checksum: sha256:https://infra.unpi.ro/files/sha256sum.txt
     become: yes
     when: verificat

   - name: "Salvez serviciul administrativ pentru calculatorul unPi"
     get_url:
       url: https://infra.unpi.ro/files/boot.unit.txt
       dest: /etc/systemd/system/unpi.boot.service
       mode: u=rw,g=r,o=r
       checksum: sha256:https://infra.unpi.ro/files/sha256sum.txt
     become: yes
     when: verificat

   - name: "Activez serviciul administrativ pentru calculatorul unPi"
     systemd:
       state: restarted
       daemon_reload: yes
       enabled: yes
       name: unpi.boot
     become: yes
     when: verificat

   - name: "Instalam mediul educational GCompris pentru copii"
     apt:
       name: gcompris
     become: yes
     when: "'WINDOWS' not in ansible_env.PATH"

   - name: "Instalam limbajul de programare vizual Scratch v3"
     apt:
       name: scratch3,omxplayer
     become: yes
     when: ansible_lsb.id == "Raspbian"

   - name: "Creez un link pe Desktop pentru imnul unPi"
     get_url:
       url: https://infra.unpi.ro/files/imn.desktop
       dest: ~/Desktop/
       checksum: sha256:https://infra.unpi.ro/files/sha256sum.txt
     when: ansible_lsb.id == "Raspbian"

   - name: "Creez un link pe Desktop pentru cursul de Scratch"
     get_url:
       url: https://infra.unpi.ro/files/scratch.desktop
       dest: ~/Desktop/
       checksum: sha256:https://infra.unpi.ro/files/sha256sum.txt
     when: ansible_lsb.id == "Raspbian"

   - name: "Instalam limbajul de programare profesional Golang"
     apt:
       name: golang
     become: yes

   - name: "Instalam programe utilitare pentru cursurile de programare"
     apt:
       name: git,nano,asciinema,vlc,bc,figlet,sysstat
     become: yes

   - name: "Pregatesc colectarea de statistici ale sistemului de operare"
     lineinfile:
       regexp: "^(.*)ENABLED=(.*)"
       line: 'ENABLED="true"'
       path: /etc/default/sysstat
     become: yes

   - name: "Activez colectarea de statistici ale sistemului de operare"
     systemd:
       state: started
       enabled: yes
       name: sysstat
     become: yes

   - name: "Stergem versiunile vechi (v1, v2) ale programului Scratch"
     apt:
       name: scratch,scratch2,atsar
       state: absent
     become: yes
     when: beneficiar and ansible_lsb.id == "Raspbian"

   - name: "Stergem editoarele ce nu vor fi folosite in cursurile unPi"
     apt:
       name: geany*,bluej,greenfoot*,smartsim
       state: absent
     become: yes
     when: beneficiar and ansible_lsb.id == "Raspbian"

   - name: "Activez instalarea automata a programelor din sistemul de operare"
     apt:
       name: unattended-upgrades,apt-listchanges
     become: yes

   - name: "(pasul urmator va dura mai mult, depinzand de conexiunea ta la Internet)"
     shell: echo; figlet te rog, asteapta

   - name: "Instalam cele mai noi aplicatii pentru calculatorul tau personal"
     apt:
       upgrade: full
       cache_valid_time: 900
     become: yes

   - name: "Calculatorul tau personal unPi este acum operational"
     uri:
       url: "http://ping.unpi.ro/ping"
       http_agent: "{{ token }}"
       status_code: [200,404]
       timeout: 10
     when: beneficiar and ansible_lsb.id == "Raspbian"
